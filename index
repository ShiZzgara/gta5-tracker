<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢—Ä–µ–∫–µ—Ä –∑–∞–¥–∞–Ω–∏–π GTA 5 RP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 16px;
            background-color: #f0f2f5;
            color: #000;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .char-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .char-tab {
            flex: 1;
            padding: 12px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
        }
        .char-tab.active {
            background-color: #007AFF;
            color: white;
        }
        .screen-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
        }
        .screen-tab {
            flex: 1;
            padding: 10px;
            background-color: #d0d0d0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .screen-tab.active {
            background-color: #007AFF;
            color: white;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .task-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        .task-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .task-name {
            font-weight: 500;
        }
        .task-count {
            font-size: 12px;
            color: #666;
        }
        .task-points {
            font-weight: 600;
            color: #007AFF;
            margin-right: 10px;
        }
        .task-controls {
            display: flex;
            gap: 5px;
        }
        .move-btn {
            background-color: #e0e0e0;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .timer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .timer-name {
            font-weight: 500;
        }
        .timer-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .timer-time {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .timer-progress {
            width: 100px;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        .timer-progress-bar {
            height: 100%;
            background-color: #007AFF;
            width: 0%;
            transition: width 0.3s;
        }
        .btn-start {
            background-color: #007AFF;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .btn-reset {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .stats-container {
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .total-points {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 16px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        .action-btn {
            flex: 1;
            padding: 12px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>–ó–∞–¥–∞–Ω–∏—è GTA 5 RP</h1>
</div>

<div class="char-tabs">
    <button class="char-tab active" data-char="karl">üë§ –ö–∞—Ä–ª –£—Ä–±–∞–Ω</button>
    <button class="char-tab" data-char="rick">üë§ –†–∏–∫ –°—Ç–≤–æ–ª–æ–≤—Å–∫–∏</button>
    <button class="char-tab" data-char="erik">üë§ –≠—Ä–∏–∫ –ë–∞—Ç—Ç–µ—Ä–±–∏–Ω</button>
</div>

<div class="screen-tabs">
    <button class="screen-tab active" data-screen="tasks">–ó–∞–¥–∞–Ω–∏—è</button>
    <button class="screen-tab" data-screen="timers">–¢–∞–π–º–µ—Ä—ã</button>
    <button class="screen-tab" data-screen="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
</div>

<div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<!-- –≠–∫—Ä–∞–Ω –∑–∞–¥–∞–Ω–∏–π -->
<div id="tasks" class="screen active">
    <div class="tasks-container"></div>
    <div class="action-buttons">
        <button class="action-btn" onclick="resetDailyTasks()">–°–±—Ä–æ—Å–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>
    </div>
</div>

<!-- –≠–∫—Ä–∞–Ω —Ç–∞–π–º–µ—Ä–æ–≤ -->
<div id="timers" class="screen">
    <div class="timers-container"></div>
</div>

<!-- –≠–∫—Ä–∞–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div id="stats" class="screen">
    <div class="stats-container">
        <div class="total-points">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    </div>
</div>

<script>
    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
    const API_URL = './api/data'; // Vercel serverless function

    // –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞)
    const TASKS_TEMPLATE = [
        { id: 1, name: "–õ–æ—Ç–µ—Ä–µ—è", points: 2 },
        { id: 2, name: "–°–∞–π—Ç", points: 2 },
        { id: 3, name: "–ë—Ä–∞–≤–ª", points: 2 },
        { id: 4, name: "–õ–∞–π–∫ –≤ match", points: 2 },
        { id: 5, name: "–ö–∏–Ω—É—Ç—å –º—è—á–∏–∫", points: 4, desc: "15 —Ä–∞–∑", count: true, max: 15 },
        { id: 6, name: "–î—Ä–µ—Å—Å–∏—Ä–æ–≤–∫–∞", points: 4, count: true, max: 15 },
        { id: 7, name: "–¢–∏—Ä", points: 2 },
        { id: 8, name: "–°—Ç–∞–≤–∫–∞ –≤ –∫–æ–ª–µ—Å–µ", points: 6, desc: "100 —Ñ–∏—à–µ–∫" },
        { id: 9, name: "–†—ã–±–∞–ª–∫–∞", points: 8, desc: "20 —Ä—ã–±" },
        { id: 10, name: "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å", points: 2, desc: "—Å–≤–æ—é –º–∞—à–∏–Ω—É" },
        { id: 11, name: "–ê—Ä–º—Ä–µ—Å–ª–∏–Ω–≥", points: 2 },
        { id: 12, name: "–ë–∞—Å–∫–µ—Ç–±–æ–ª", points: 2, desc: "2 –º—è—á–∞" },
        { id: 13, name: "–§—É—Ç–±–æ–ª", points: 2, desc: "2 –º—è—á–∞" },
        { id: 14, name: "–ó–∞–¥–∞–Ω–∏—è –∫–ª—É–±–∞", points: 8, count: true, max: 2 },
        { id: 15, name: "–î–∞—Ä—Ç—Å", points: 2 },
        { id: 16, name: "–í–æ–ª–µ–π–±–æ–ª", points: 2, desc: "1 –º–∏–Ω—É—Ç–∞" },
        { id: 17, name: "–ü–∏–Ω–≥-–ø–æ–Ω–≥", points: 2, desc: "1 –º–∏–Ω—É—Ç–∞" },
        { id: 18, name: "–¢–µ–Ω–Ω–∏—Å", points: 2, desc: "1 –º–∏–Ω—É—Ç–∞" },
        { id: 19, name: "–°—ã–≥—Ä–∞—Ç—å –≤ –º–∞—Ñ–∏—é", points: 6 },
        { id: 20, name: "–ü–ª–∞—Ç–µ–∂ –ø–æ –ª–∏–∑–∏–Ω–≥—É", points: 2 },
        { id: 21, name: "–ì–æ–Ω–∫–∞", points: 2, desc: "—Å—Ç–∞–≤–∫–∞ 1000" },
        { id: 22, name: "–ê—Ä–µ–Ω–∞", points: 2, count: true, max: 3, desc: "–ø–æ–±–µ–¥–∞" },
        { id: 23, name: "–°—Ç—Ä–æ–π–∫–∞", points: 4, desc: "25 –¥–µ–π—Å—Ç–≤–∏–π" },
        { id: 24, name: "–ü–æ—Ä—Ç", points: 4, desc: "25 –¥–µ–π—Å—Ç–≤–∏–π" },
        { id: 25, name: "–®–∞—Ö—Ç–∞", points: 4, desc: "25 –¥–µ–π—Å—Ç–≤–∏–π" },
        { id: 26, name: "–§–µ—Ä–º–∞", points: 2, desc: "10 –¥–µ–π—Å—Ç–≤–∏–π" },
        { id: 27, name: "–ö–∞—Ä—Ç–∏–Ω–≥", points: 2, desc: "–ø–æ–±–µ–¥–∞" },
        { id: 28, name: "–°–æ–∫—Ä–æ–≤–∏—â–µ", points: 2 },
        { id: 29, name: "–ê–≤—Ç–æ–±—É—Å", points: 4, count: true, max: 2 },
        { id: 30, name: "–ü–æ—á—Ç–∞", points: 2, count: true, max: 10 },
        { id: 31, name: "–ù—É–ª–∏ –≤ –∫–∞–∑–∏–Ω–æ", points: 4 },
        { id: 32, name: "–¢—Ä–µ–Ω–∞–∂–µ—Ä–∫–∞", points: 2, desc: "20 –¥–µ–π—Å—Ç–≤–∏–π" },
        { id: 33, name: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å", points: 2, count: true, max: 5, desc: "–ø–æ–±–µ–¥—ã –æ—Ç 100$" },
        { id: 34, name: "–®–∫—É—Ä—ã", points: 4, count: true, max: 5, desc: "100 –∫–∞—á–µ—Å—Ç–≤–æ" },
        { id: 35, name: "–ü–æ–∂–∞—Ä–Ω—ã–π", points: 2, count: true, max: 25 },
        { id: 36, name: "–î–∞–ª—å–Ω–æ–±–æ–π—â–∏–∫", points: 4, count: true, max: 3 },
        { id: 37, name: "–ö–∏–Ω–æ—Å—Ç—É–¥–∏—è", points: 4 },
        { id: 38, name: "–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä", points: 2, desc: "–∑–∞–≥—Ä—É–∑–∏—Ç—å 5 —Ä–æ–ª–∏–∫–æ–≤" },
        { id: 39, name: "–ú–µ—Ç—Ä–æ", points: 4 },
        { id: 40, name: "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å", points: 4, desc: "–º–∞—à–∏–Ω—É –¥—Ä—É–≥–∞" }
    ];

    const TIMERS_TEMPLATE = [
        { name: "–î—Ä–µ—Å—Å–∏—Ä–æ–≤–∫–∞", duration: 15 * 60 },
        { name: "–ü–æ—á—Ç–∞", duration: 10 * 60 },
        { name: "–†–µ–¥–Ω–µ–∫–∏", duration: 2 * 60 * 60 },
        { name: "–ö–∞—Ä–º–∏—Ç", duration: 2 * 60 * 60 },
        { name: "–¢–∏—Ä", duration: 90 * 60 }
    ];

    let currentChar = 'karl';
    let serverData = {
        karl: { tasks: {}, timers: {} },
        rick: { tasks: {}, timers: {} },
        erik: { tasks: {}, timers: {} }
    };

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    async function apiCall(method, body = null) {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ method, char: currentChar, ...body })
        });
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        return await res.json();
    }

    function formatTime(seconds) {
        if (seconds < 0) seconds = 0;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function calculatePoints(tasksState) {
        let total = 0;
        TASKS_TEMPLATE.forEach(task => {
            const state = tasksState[task.id] || {};
            if (state.completed) total += task.points;
        });
        return total;
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ===
    document.querySelectorAll('.char-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.char-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentChar = tab.dataset.char;
            renderAll();
        });
    });

    document.querySelectorAll('.screen-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.screen-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.screen).classList.add('active');
            if (tab.dataset.screen === 'stats') renderStats();
        });
    });

    async function toggleTask(id) {
        const task = TASKS_TEMPLATE.find(t => t.id === id);
        const currentState = serverData[currentChar].tasks[id] || {};
        let newCompleted = !currentState.completed;
        let newCount = currentState.count || 0;

        if (task.count) {
            if (!currentState.completed) {
                newCount++;
                if (newCount >= task.max) {
                    newCompleted = true;
                } else {
                    newCompleted = false;
                }
            }
        }

        await apiCall('updateTask', { taskId: id, completed: newCompleted, count: newCount });
        await loadData();
        renderAll();
    }

    async function resetTaskProgress(id) {
        await apiCall('updateTask', { taskId: id, completed: false, count: 0 });
        await loadData();
        renderAll();
    }

    async function resetDailyTasks() {
        await apiCall('resetTasks');
        await loadData();
        renderAll();
    }

    async function toggleTimer(name) {
        const timer = serverData[currentChar].timers[name];
        if (timer && timer.active) {
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            await apiCall('stopTimer', { timerName: name });
        } else {
            // –ó–∞–ø—É—Å—Ç–∏—Ç—å
            await apiCall('startTimer', { timerName: name });
        }
        await loadData();
        renderAll();
    }

    async function resetTimer(name) {
        await apiCall('resetTimer', { timerName: name });
        await loadData();
        renderAll();
    }

    // === –†–ï–ù–î–ï–† ===
    function renderTasks() {
        const container = document.querySelector('.tasks-container');
        const tasksState = serverData[currentChar].tasks;
        container.innerHTML = '';

        TASKS_TEMPLATE.forEach((task, index) => {
            const state = tasksState[task.id] || {};
            const completed = state.completed || false;
            const count = state.count || 0;

            let countText = '';
            if (task.count) countText = ` (${count}/${task.max})`;
            let descText = task.desc ? ` - ${task.desc}` : '';

            const el = document.createElement('div');
            el.className = 'task-item';
            el.innerHTML = `
                <div class="task-left">
                    <input type="checkbox" class="task-checkbox" ${completed ? 'checked' : ''} onchange="toggleTask(${task.id})">
                    <div class="task-info">
                        <div class="task-name">${task.name}${countText}</div>
                        ${descText ? `<div class="task-count">${descText}</div>` : ''}
                    </div>
                    <div class="task-points">+${task.points}</div>
                </div>
                <div class="task-controls">
                    ${task.count ? `<button class="reset-btn" onclick="resetTaskProgress(${task.id})" title="–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å">‚Ü∫</button>` : ''}
                    <button class="move-btn" onclick="moveTask(${index}, 'up')" disabled>‚Üë</button>
                    <button class="move-btn" onclick="moveTask(${index}, 'down')" disabled>‚Üì</button>
                </div>
            `;
            container.appendChild(el);
        });
    }

    function renderTimers() {
        const container = document.querySelector('.timers-container');
        const timersState = serverData[currentChar].timers;
        container.innerHTML = '';

        TIMERS_TEMPLATE.forEach(timerDef => {
            const state = timersState[timerDef.name] || {};
            const active = state.active || false;
            const startedAt = state.startedAt || 0;
            const now = Date.now();
            const elapsed = startedAt ? Math.floor((now - startedAt) / 1000) : 0;
            const remaining = Math.max(0, timerDef.duration - elapsed);
            const progress = startedAt ? (elapsed / timerDef.duration) * 100 : 0;

            const el = document.createElement('div');
            el.className = 'timer-item';
            el.innerHTML = `
                <div><div class="timer-name">${timerDef.name}</div></div>
                <div class="timer-display">
                    <div class="timer-time">${formatTime(remaining)}</div>
                    <div class="timer-progress">
                        <div class="timer-progress-bar" style="width: ${Math.min(100, progress)}%"></div>
                    </div>
                    <button class="btn-start" onclick="toggleTimer('${timerDef.name}')">${active ? '–°—Ç–æ–ø' : '–°—Ç–∞—Ä—Ç'}</button>
                    <button class="btn-reset" onclick="resetTimer('${timerDef.name}')">–°–±—Ä–æ—Å</button>
                </div>
            `;
            container.appendChild(el);
        });
    }

    function renderStats() {
        const container = document.querySelector('.stats-container');
        let html = '<div class="total-points">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>';
        ['karl', 'rick', 'erik'].forEach(charId => {
            const name = { karl: '–ö–∞—Ä–ª –£—Ä–±–∞–Ω', rick: '–†–∏–∫ –°—Ç–≤–æ–ª–æ–≤—Å–∫–∏', erik: '–≠—Ä–∏–∫ –ë–∞—Ç—Ç–µ—Ä–±–∏–Ω' }[charId];
            const points = calculatePoints(serverData[charId].tasks);
            html += `<div style="padding:12px 0;border-bottom:1px solid #eee;"><strong>${name}:</strong> ${points} –æ—á–∫–æ–≤</div>`;
        });
        container.innerHTML = html;
    }

    function renderAll() {
        renderTasks();
        renderTimers();
        if (document.getElementById('stats').classList.contains('active')) {
            renderStats();
        }
    }

    // === –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===
    async function loadData() {
        try {
            const res = await fetch(API_URL + `?char=${currentChar}`);
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            serverData = await res.json();
            document.getElementById('status').textContent = '';
        } catch (e) {
            console.error(e);
            document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
        }
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    loadData().then(() => {
        renderAll();
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ (–¥–ª—è —Ç–∞–π–º–µ—Ä–æ–≤)
        setInterval(() => {
            if (document.getElementById('timers').classList.contains('active')) {
                loadData().then(renderAll);
            }
        }, 10000);
    });

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å (–¥–ª—è onclick)
    window.toggleTask = toggleTask;
    window.resetTaskProgress = resetTaskProgress;
    window.resetDailyTasks = resetDailyTasks;
    window.toggleTimer = toggleTimer;
    window.resetTimer = resetTimer;
    window.moveTask = () => {}; // –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
</script>

</body>
</html>
