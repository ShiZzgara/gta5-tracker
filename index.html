<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢—Ä–µ–∫–µ—Ä –∑–∞–¥–∞–Ω–∏–π GTA 5 RP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 16px; background: #f0f2f5; color: #000; }
        .header { text-align: center; margin-bottom: 20px; }
        .screen-tabs { display: flex; gap: 4px; margin-bottom: 20px; }
        .screen-tab { flex: 1; padding: 10px; background: #d0d0d0; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .screen-tab.active { background: #007AFF; color: white; }
        .screen { display: none; }
        .screen.active { display: block; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: white; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .task-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .task-checkbox { width: 24px; height: 24px; cursor: pointer; }
        .task-info { display: flex; flex-direction: column; flex: 1; }
        .task-name { font-weight: 500; }
        .task-count { font-size: 12px; color: #666; }
        .task-points { font-weight: 600; color: #007AFF; margin-right: 10px; }
        .timer-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: white; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .timer-name { font-weight: 500; }
        .timer-display { display: flex; flex-direction: column; align-items: flex-end; }
        .timer-time { font-weight: 600; margin-bottom: 4px; }
        .timer-progress { width: 100px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .timer-progress-bar { height: 100%; background: #007AFF; width: 0%; transition: width 0.3s; }
        .btn-start { background: #007AFF; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-bottom: 5px; }
        .btn-reset { background: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .stats-container { padding: 16px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .total-points { font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 16px; }
        .action-buttons { display: flex; gap: 10px; margin-top: 16px; }
        .action-btn { flex: 1; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; }
        .status { text-align: center; margin: 10px 0; font-size: 14px; color: #666; }
    </style>
</head>
<body>

<div class="header">
    <h1>üë§ –ö–∞—Ä–ª –£—Ä–±–∞–Ω ‚Äî –ó–∞–¥–∞–Ω–∏—è GTA 5 RP</h1>
</div>

<div class="screen-tabs">
    <button class="screen-tab active" data-screen="tasks">–ó–∞–¥–∞–Ω–∏—è</button>
    <button class="screen-tab" data-screen="timers">–¢–∞–π–º–µ—Ä—ã</button>
    <button class="screen-tab" data-screen="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
</div>

<div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="tasks" class="screen active">
    <div class="tasks-container"></div>
    <div class="action-buttons">
        <button class="action-btn" onclick="resetDailyTasks()">–°–±—Ä–æ—Å–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>
    </div>
</div>

<div id="timers" class="screen">
    <div class="timers-container"></div>
</div>

<div id="stats" class="screen">
    <div class="stats-container">
        <div class="total-points">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div id="points-display"></div>
    </div>
</div>

<script>
    const API_URL = '/api/data';
    let tasks = {};
    let timers = {};
    let clientTimers = {}; // –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã

    const TASKS = [ /* ... –≤–∞—à –º–∞—Å—Å–∏–≤ TASKS ... */ ]; // ‚Üê –û–°–¢–ê–í–¨–¢–ï –°–í–û–ô –ú–ê–°–°–ò–í –ó–ê–î–ê–ù–ò–ô –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô

    const TIMER_DEFS = [
        { name: "–î—Ä–µ—Å—Å–∏—Ä–æ–≤–∫–∞", duration: 15 * 60 },
        { name: "–ü–æ—á—Ç–∞", duration: 10 * 60 },
        { name: "–†–µ–¥–Ω–µ–∫–∏", duration: 2 * 60 * 60 },
        { name: "–ö–∞—Ä–º–∏—Ç", duration: 2 * 60 * 60 },
        { name: "–¢–∏—Ä", duration: 90 * 60 }
    ];

    // === API ===
    async function callAPI(method, body = {}) {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ method, ...body })
        });
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ API');
        return await res.json();
    }

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            const data = await res.json();
            tasks = data.tasks || {};
            timers = data.timers || {};
            document.getElementById('status').textContent = '';
            renderAll();
            startClientTimers(); // ‚Üê –∑–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã
        } catch (e) {
            console.error(e);
            document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
        }
    }

    // === –ö–õ–ò–ï–ù–¢–°–ö–ò–ï –¢–ê–ô–ú–ï–†–´ ===
    function startClientTimers() {
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ
        Object.values(clientTimers).forEach(id => clearInterval(id));
        clientTimers = {};

        TIMER_DEFS.forEach(tdef => {
            const state = timers[tdef.name] || { active: false, startedAt: 0 };
            if (state.active && state.startedAt) {
                clientTimers[tdef.name] = setInterval(() => {
                    renderTimers(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–∞–π–º–µ—Ä—ã
                }, 1000);
            }
        });
    }

    // === –†–ï–ù–î–ï–† ===
    function formatTime(sec) {
        sec = Math.max(0, sec);
        return `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
    }

    function getPoints() {
        let total = 0;
        TASKS.forEach(t => {
            const state = tasks[t.id] || {};
            if (state.completed) total += t.points;
        });
        return total;
    }

    function renderTasks() {
        // ... –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ renderTasks() –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
    }

    function renderTimers() {
        const container = document.querySelector('.timers-container');
        container.innerHTML = '';
        TIMER_DEFS.forEach(tdef => {
            const state = timers[tdef.name] || { active: false, startedAt: 0 };
            const now = Date.now();
            const elapsed = state.startedAt ? Math.floor((now - state.startedAt) / 1000) : 0;
            const remaining = Math.max(0, tdef.duration - elapsed);
            const progress = state.startedAt ? Math.min(100, (elapsed / tdef.duration) * 100) : 0;

            const el = document.createElement('div');
            el.className = 'timer-item';
            el.innerHTML = `
                <div><div class="timer-name">${tdef.name}</div></div>
                <div class="timer-display">
                    <div class="timer-time">${formatTime(remaining)}</div>
                    <div class="timer-progress">
                        <div class="timer-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <button class="btn-start" onclick="toggleTimer('${tdef.name}')">${state.active ? '–°—Ç–æ–ø' : '–°—Ç–∞—Ä—Ç'}</button>
                    <button class="btn-reset" onclick="resetTimer('${tdef.name}')">–°–±—Ä–æ—Å</button>
                </div>
            `;
            container.appendChild(el);
        });
    }

    function renderStats() {
        document.getElementById('points-display').innerText = `–û—á–∫–∏: ${getPoints()}`;
    }

    function renderAll() {
        renderTasks();
        renderTimers();
        if (document.getElementById('stats').classList.contains('active')) {
            renderStats();
        }
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ===
    async function toggleTask(id) {
        // ... –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
    }

    async function resetTaskProgress(id) {
        // ... –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
    }

    async function resetDailyTasks() {
        // ... –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
    }

    async function toggleTimer(name) {
        const state = timers[name] || { active: false };
        if (state.active) {
            await callAPI('stopTimer', { timerName: name });
        } else {
            await callAPI('startTimer', { timerName: name });
        }
        await loadData(); // –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ç–∞–π–º–µ—Ä—ã
    }

    async function resetTimer(name) {
        await callAPI('resetTimer', { timerName: name });
        await loadData();
    }

    // === –°–û–ë–´–¢–ò–Ø ===
    document.querySelectorAll('.screen-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.screen-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.screen).classList.add('active');
            if (tab.dataset.screen === 'stats') renderStats();
        });
    });

    window.toggleTask = toggleTask;
    window.resetTaskProgress = resetTaskProgress;
    window.resetDailyTasks = resetDailyTasks;
    window.toggleTimer = toggleTimer;
    window.resetTimer = resetTimer;

    // === –°–¢–ê–†–¢ ===
    loadData();
</script>

</body>
</html>
